# ESP32-S3 物联网家庭网关- v4.2

[中文](README.md) | [English](README_en.md)

本项目是一个基于 ESP-IDF v5.5 框架开发的高可用性物联网网关系统。系统采用事件驱动架构设计，集成了华为云 IoTDA 接入、本地局域网双向控制、离线断点续传以及硬件故障自愈机制。旨在提供一个在弱网环境和硬件干扰下依然能够稳定运行的参考设计。
本项目亦作为自己求职时的作品集内项目之一。

## 核心特性

### 1. 稳健的系统架构
*   **事件驱动总线**：系统内部通过 FreeRTOS 队列构建统一的消息总线，实现业务逻辑控制器与外设驱动的完全解耦。
*   **双核并发调度**：充分利用 ESP32-S3 双核特性，将网络通信堆栈与传感器采样任务分离，保证实时性。
*   **生命周期托管**：实现了 MQTT 客户端与网络状态的严格联动，杜绝断网下的资源泄漏与 DNS 解析死锁。

### 2. 工业级可靠性设计
*   **I2C 总线自愈**：针对 I2C 从机死锁问题，实现了 9 脉冲恢复序列与手动 STOP 信号机制，并支持物理层硬复位。
*   **硬件故障隔离**：OLED 显示屏与 AHT20 传感器挂载于独立的 I2C 硬件控制器（Port 0/1），单点故障不影响系统主流程。
*   **智能看门狗**：集成任务级硬件看门狗，覆盖所有关键业务线程，防止死锁。
*   **网络指数退避**：WiFi 重连采用指数退避算法，避免网络震荡时的资源耗尽。

### 3. 数据完整性保障
*   **离线断点续传**：基于 SPIFFS 文件系统实现本地数据持久化。在网络中断期间自动缓存遥测数据，网络恢复后自动执行流量整形同步。
*   **全量状态同步**：支持设备影子（Device Shadow）双向同步，确保云端与本地的配置、阈值及开关状态实时一致。

### 4. 多维交互模式
*   **云端控制**：支持华为云 IoTDA 的属性上报、命令下发及同步响应。
*   **局域网控制**：内置 UDP 服务，支持设备发现、实时数据广播及本地指令控制，实现无公网环境下的应急管理。
*   **无感刷新 UI**：基于 OLED 的局部刷新算法，消除了数据跳变时的屏幕闪烁。

## 工程结构

项目采用组件化设计，核心逻辑位于 `components` 目录下：

```text
├── components/
│   ├── aht20/              # AHT20 温湿度传感器驱动
│   ├── ssd1306/            # OLED 显示驱动 (I2C)
│   ├── common/             # 通用数据类型与消息定义
│   ├── logs/               # 离线日志存储模块 (Data Logger)
│   ├── mqtt_huawei/        # 华为云 MQTT 协议栈与物模型封装
│   ├── state_machine/      # 核心状态管理组件
│   │   ├── settings.c      # NVS 配置持久化与全局互斥锁
│   │   └── hw_recovery.c   # 硬件故障检测与物理层恢复逻辑
│   └── wifi/               # 网络通信组件
│       ├── wifi_station.c  # WiFi 连接与重连策略管理
│       └── lan_service.c   # UDP 局域网广播与指令服务
├── main/
│   ├── main.c              # 业务逻辑控制器 (Controller)
│   └── Kconfig.projbuild   # 项目级 KConfig 配置
├── partitions.csv          # 自定义分区表 (含 storage 分区)
└── CMakeLists.txt          # 构建脚本
```

## 环境配置与编译

本项目依赖 **ESP-IDF v5.2** 及以上版本。

1.  **配置项目**
    运行配置菜单以设置 WiFi 凭证、MQTT 三元组及硬件引脚：
    ```bash
    idf.py menuconfig
    ```
    *   **WiFi Configuration**: 设置 SSID 和密码。
    *   **Huawei Cloud IoT**: 设置 Broker 地址、Device ID、Client ID 及 Password。
    *   **AHT20/SSD1306**: 配置对应的 SDA/SCL 引脚（建议分不同 Port）。
    *   **Local Network**: 配置 UDP 广播目标地址。

2.  **编译与烧录**
    ```bash
    idf.py build flash monitor
    ```

## 硬件连接

建议连接方案（可根据 KConfig 调整）：

| 模块 | 信号 | ESP32-S3 引脚 | 说明 |
| :--- | :--- | :--- | :--- |
| **SSD1306 OLED** | SDA | GPIO 8 | I2C Port 0 |
| | SCL | GPIO 9 | I2C Port 0 |
| **AHT20 Sensor** | SDA | GPIO 10 | I2C Port 1 |
| | SCL | GPIO 11 | I2C Port 1 |

## 上位机配套

本项目提供基于 **Qt 6 / QML** 开发的上位机控制台 `ESP_UCP`，支持：
*   自动发现局域网内的网关设备。
*   实时显示温湿度曲线与设备状态。
*   本地下发控制指令（报警、阈值设定、网络重置）。
*   接收并显示远程调试日志。
（已新建文件夹）

## 版本历史

*   **v4.2**：集成硬件自愈模块，优化 I2C 驱动超时机制，实现全链路热插拔支持。
*   **v4.0**：新增局域网 UDP 服务与离线数据存储功能。
*   **v3.0**：重构为事件总线架构，引入 NVS 配置管理。
*   **v2.0**：实现基础 WiFi/MQTT 通信与多任务调度。

---
**许可证类型**: MIT  
**作者**: Michael Cookies
**第三方组件**
1. SSD1306显示驱动
- **来源**：[nopnop2002/esp-idf-ssd1306](https://github.com/nopnop2002/esp-idf-ssd1306)
- **许可证**：MIT License
- **使用方式**：复制了 `component/ssd1306` 目录到本项目
- **修改内容**：优化了I2C初始化逻辑
- **版权声明**：Copyright (c) 2022 nopnop2002